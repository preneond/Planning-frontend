  <!DOCTYPE html>
  <html>
  <head>
      <meta charset='utf-8' />
      <title>Intermodal Planner</title>
      <meta name='viewport' content='initial-scale=1,maximum-scale=1,user-scalable=no' />
      <link rel="stylesheet" href="libraries/awesomplete/awesomplete.css" />
      <script src="libraries/awesomplete/awesomplete.js"></script>
      <script src='https://api.tiles.mapbox.com/mapbox-gl-js/v0.44.1/mapbox-gl.js'></script>
      <link href='https://api.tiles.mapbox.com/mapbox-gl-js/v0.44.1/mapbox-gl.css' rel='stylesheet' />
      <style>
          body {
            margin:0;
            padding:0;
          }
          img {
            margin-right: 20px;
          }
          #map {
            position:absolute;
            top:0;
            bottom:0;
            width:100%;
          }
          #search-box {
            position:absolute;
            margin:50px 50px 50px 50px;
            padding: 10px 10px 10px 10px;
            width: 400px;
            height:150px;
            background-color: white;
            border-radius: 15px;
            background: rgba(255,255,255,0.9);
          }
          #search-table {
            position: relative;
            width: 90%;
            height: 100%;
          }
          #search-table tr {
            position: relative;
            height: 50px;
            width: 200px;
          }
          #search-table input {
            position: relative;
            width: 80%;
            height: 80%;
            font-size: 14px;
          }

          #search-table button {
            position: relative;
            width: 100%;
            height: 80%;
            font-size: 14px;
          }
          #planRouteBtn {
            border: none;
            color: white;
            background-color: green;
          }

          @keyframes shake {
            10%, 90% {
              transform: translate3d(-1px, 0, 0);
            }

            20%, 80% {
              transform: translate3d(2px, 0, 0);
            }

            30%, 50%, 70% {
              transform: translate3d(-4px, 0, 0);
            }

            40%, 60% {
              transform: translate3d(4px, 0, 0);
            }
          }

          .apply-shake {
            animation: shake 0.82s cubic-bezier(.36,.07,.19,.97) both;
          }
      </style>
  </head>
  <body>

  <div id='map'></div>

  <div id="search-box">

    <div id="search-input">
      <table id="search-table">
        <tbody>
          <tr>
            <th>
              <input id="originInput" placeholder="Origin place"/>
            </th>
            <th>
                <img id="originMarker" src="img/markers/marker_origin.png" alt="" height=30 />
            </th>
          </tr>
          <tr>
            <th>
              <!-- <input id="placeInput" placeholder="Destination place"/> -->
              <input id="destinationInput" placeholder="Destination place"/>
            </th>
            <th>
              <img id="destinationMarker" src="img/markers/marker_destination.png" alt="" height=30 />
            </th>
          </tr>
          <tr>
            <th>
              <img id="carIcon" src="img/transport_modes/car_enabled.png" alt="" height=25 />
              <img id="transitIcon" src="img/transport_modes/transit_enabled.png" alt="" height=25 />
              <img id="bikeIcon" src="img/transport_modes/bike_enabled.png" alt="" height=25 />
              <img id="walkIcon" src="img/transport_modes/walk_enabled.png" alt="" height=25 />
            </th>
            <th>
              <button id="planRouteBtn">Find</button>
            </th>
          </tr>
        </tbody>
      </table>
    </div>
  </div>
  <script>
  var originMarkEnabled = false;
  var originPicked = false;
  var destinationMarkEnabled = false;
  var destinationPicked = false;

  var carEnabled = true;
  var transitEnabled = true;
  var bikeEnabled = true;
  var walkEnabled = true;

  var carEnabledSrc = "img/transport_modes/car_enabled.png"
  var carDisabledSrc = "img/transport_modes/car_disabled.png"
  var transitEnabledSrc = "img/transport_modes/transit_enabled.png"
  var transitDisabledSrc = "img/transport_modes/transit_disabled.png"
  var bikeEnabledSrc = "img/transport_modes/bike_enabled.png"
  var bikeDisabledSrc = "img/transport_modes/bike_disabled.png"
  var walkEnabledSrc = "img/transport_modes/walk_enabled.png"
  var walkDisabledSrc = "img/transport_modes/walk_disabled.png"

  var featureList = {};

  var originIconElm = document.getElementById("originMarker");
  originIconElm.addEventListener("animationend", e => {
    e.target.classList.remove("apply-shake");
  });

  var destinationIconElm = document.getElementById("destinationMarker");
  destinationIconElm.addEventListener("animationend", e => {
    e.target.classList.remove("apply-shake");
  });

  var originMarkerElm = document.createElement('img');
  originMarkerElm.style.height = "30px";
  originMarkerElm.src = "img/markers/marker_origin.png";
  var originMapMarker = new mapboxgl.Marker(originMarkerElm);

  var destinationMarkerElm = document.createElement('img');
  destinationMarkerElm.style.height = "30px";
  destinationMarkerElm.src = "img/markers/marker_destination.png"
  var destinationMapMarker = new mapboxgl.Marker(destinationMarkerElm);

  var originComplete = new Awesomplete(originInput, {});
  var destinationComplete = new Awesomplete(destinationInput, {});

  var originInput = document.getElementById("originInput");
  originInput.addEventListener('input', autoComplete);
  originInput.addEventListener('keyup', function(e) {
    if (e.keyCode === 13) inputDidConfirmed(e)
  })

  var destinationInput = document.getElementById("destinationInput");
  destinationInput.addEventListener('input', autoComplete);
  destinationInput.addEventListener('keyup', function(e) {
    if (e.keyCode === 13) inputDidConfirmed(e)
  })

  var carIconElm = document.getElementById("carIcon");
  carIconElm.addEventListener("click", modeClicked);

  const transitIconElm = document.getElementById("transitIcon");
  transitIconElm.addEventListener("click", modeClicked);

  const bikeIconElm = document.getElementById("bikeIcon");
  bikeIconElm.addEventListener("click", modeClicked);

  const walkIconElm = document.getElementById("walkIcon");
  walkIconElm.addEventListener("click", modeClicked);

  const planRouteBtnElm = document.getElementById("planRouteBtn")
  planRouteBtnElm.addEventListener("click", planRoute);

  function modeClicked(e) {
    switch (e.target.id) {
      case "carIcon":
        carEnabled = !carEnabled;
        e.target.src = carEnabled ? carEnabledSrc : carDisabledSrc;
        break;
      case "transitIcon":
        transitEnabled = !transitEnabled;
        e.target.src = transitEnabled ? transitEnabledSrc : transitDisabledSrc;
        break;
        case "bikeIcon":
          bikeEnabled = !bikeEnabled;
          e.target.src = bikeEnabled ? bikeEnabledSrc : bikeDisabledSrc;
          break;
        case "walkIcon":
          walkEnabled = !walkEnabled;
          e.target.src = walkEnabled ? walkEnabledSrc : walkDisabledSrc;
          break;
    }
  }

  function autoComplete(e) {
      const text = e.target.value
      if (text.length < 2) return;

      const centerCoords = map.getCenter();
      const autoCompleteURL = "https://uc1.umotional.net/geocoding/autocomplete"

      var reqURL = autoCompleteURL + "?text=" + text;
      if (centerCoords != null) {
          reqURL += "&focus.point.lat=" + centerCoords.lat;
          reqURL += "&focus.point.lon=" + centerCoords.lng;
      }

      fetch(reqURL)
      .then(response => response.json())
      .then(json => autocompleteListDidChange(e,json));
    }

    function reverseGeocoding(e) {
      const reverseGeocodingURL = "https://uc1.umotional.net/geocoding/reverse"

      var reqURL = reverseGeocodingURL
      reqURL += "?point.lat=" + e.lngLat.lat
      reqURL += "&point.lon=" + e.lngLat.lng;

      fetch(reqURL)
      .then(response => response.json())
      .then(json => mapDidClicked(json));
    }

    function autocompleteListDidChange(e, response) {
      featureList = response.features;
      if (e.target.id == "originInput") {
        originComplete.list = featureList.map(feature => feature.properties.uc_label);
        originComplete.evaluate()
      } else {
        destinationComplete.list = featureList.map(feature => feature.properties.uc_label);
        destinationComplete.evaluate()
      }
    }

    function inputDidConfirmed(e) {
      const inputText = e.target.value;
      const feature = featureList.filter( feature => feature.properties.uc_label == inputText)[0];
      const coords = feature.geometry.coordinates;
      if (e.target.id == "originInput") {
        pickOrigin(coords, inputText)
      } else {
        pickDestination(coords, inputText)

      }
      map.flyTo({center: coords});
    }

    function planRoute(e) {
      if (!originPicked) {
        originIconElm.classList.add("apply-shake");
      }
      if (!destinationPicked) {
        destinationIconElm.classList.add("apply-shake");
      }
    }

    function mapDidClicked(json) {
      let feature = json.features[0]

      let coords = feature.geometry.coordinates;
      let label = feature.properties.uc_label

      if (!originPicked) {
        originInput.value = label
        pickOrigin(coords);
      } else if (!destinationPicked) {
        destinationInput.value = label;
        pickDestination(coords)
      }
    }

    function pickOrigin(coordinates, text = "") {
      originPicked = true
      originMapMarker
      .setLngLat(coordinates)
      .setPopup(new mapboxgl.Popup({ offset: 25 }).setText(text))
      .addTo(map);
    }

    function pickDestination(coordinates, text = "") {
      destinationPicked = true
      destinationMapMarker
      .setLngLat(coordinates)
      .setPopup(new mapboxgl.Popup({ offset: 25 }).setText(text))
      .addTo(map);
    }

    mapboxgl.accessToken = 'pk.eyJ1IjoicHJlbmVvbmQiLCJhIjoiY2o1ZGxlbGMxMGxicTJxcnlqMXdoYXZtciJ9.myreL4tEUijFKkauE1ysbA';

    var map = new mapboxgl.Map({
        container: 'map', // container id
        style: 'mapbox://styles/mapbox/streets-v9', // stylesheet location
        center: [14.42076, 50.08804], // starting position [lng, lat]
        zoom: 12 // starting zoom
    });

    map.on('click', reverseGeocoding);

    if ("geolocation" in navigator) {
      navigator.geolocation.getCurrentPosition(position => {
        var location = [position.coords.longitude, position.coords.latitude];
        map.flyTo({center: [position.coords.longitude, position.coords.latitude]});
      });
    } else {
      var location = [14.42076, 50.08804];
    }
  </script>

  </body>
  </html>
